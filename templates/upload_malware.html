{% extends "base.html" %}

{% block window_title %}Malware Upload & Analyse{% endblock %}
{% block page_heading %}Malware-Sample hochladen & analysieren{% endblock %}

{% block content %}
    <p>Laden Sie eine einzelne Datei hoch. Der SHA256-Hash wird berechnet, optional bei VirusTotal gepr√ºft und die Datei mit dem Standard-Passwort ('infected') archiviert. Anschlie√üend wird eine (simulierte) Sandbox-Analyse durchgef√ºhrt.</p>

    <form method="post" enctype="multipart/form-data" class="styled-form" id="malware-form">
         <div class="form-group">
            <label for="file">Datei ausw√§hlen:</label>
            <input type="file" id="file" name="file" required>
        </div>
         <div class="form-group form-actions">
            <button type="submit" class="btn btn-primary" id="submit-button-mw">Hochladen & Analysieren</button>
            <div class="loading-indicator" id="loading-indicator-mw" style="display: none;">
                 <div class="spinner"></div>
                 <span>Wird verarbeitet...</span>
            </div>
        </div>
    </form>

    {% if upload_info and upload_info.original_filename %}
    <hr>
    <div class="results-section">
        <h3>Ergebnisse f√ºr: {{ upload_info.original_filename | e }}</h3>

        {% if upload_info.analysis_results %}
        <div class="result-block">
            <strong>Analyse-√úbersicht:</strong>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Quelle</th>
                        <th>Ergebnis</th>
                        <th>Details / Link</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in upload_info.analysis_results %}
                    <tr>
                        <td>{{ result.source | e }}</td>

                        {% set current_status = result.get('raw_status', 'unknown') | lower %}
                        <td class="verdict status-{{ current_status | e }}">
                            {% set verdict_text = '' %}
                            {% if current_status == 'ok' or current_status == 'benign' %}
                                {% set verdict_text = 'Gutartig' %}
                            {% elif current_status == 'suspicious' %}
                                {% set verdict_text = 'Verd√§chtig' %}
                            {% elif current_status == 'malicious' %}
                                {% set verdict_text = 'B√∂sartig' %}
                            {% elif current_status == 'info' %}
                                {% set verdict_text = 'Info' %}
                            {% elif current_status == 'not_found' %}
                                {% set verdict_text = 'N/G' %}
                            {% elif current_status == 'error' %}
                                {% set verdict_text = 'Fehler' %}
                            {% else %}
                                {% set verdict_text = result.raw_status | title if result.raw_status else 'Unbekannt' %}
                            {% endif %}
                            {{ verdict_text }}
                        </td>

                        <td class="additional-info">
                            {% if result.error_message %}
                                <span class="error-text">Fehler: {{ result.error_message | e }}</span>
                            {% elif result.link %}
                                {% set external_sources = ['VirusTotal'] %}
                                {% if result.connector_name in external_sources %}
                                    <a href="{{ result.link }}" target="_blank" title="Details auf {{ result.connector_name }} ansehen" class="vt-link">Externen Bericht √∂ffnen üîó</a><br>
                                {% endif %}
                            {% endif %}

                            {% if result.details and result.details.event_id %}
                                <small>Event: {{ result.details.event_id }} ({{ (result.details.event_info[:30] + '...') if result.details.event_info and result.details.event_info|length > 30 else result.details.event_info }})</small><br>
                            {% endif %}
                            {% if result.details and result.details.labels %}
                                <small>Labels: {{ result.details.labels | join(', ') }}</small><br>
                            {% endif %}
                             {% if result.details and result.details.detection_ratio and result.details.detection_ratio != 'N/A' %}
                             {% endif %}

                            {% if not result.error_message %}
                                {% set something_shown = (result.details and result.details.event_id) or
                                                           (result.details and result.details.labels) or
                                                           (result.details and result.details.get('detection_ratio') and result.details.get('detection_ratio') != 'N/A') %}
                                {% if not something_shown and result.summary %}
                                     <small>{{ result.summary | e }}</small>
                                {% elif not something_shown and not result.summary %}
                                     <small>(Keine Zusatzinfos)</small>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

    </div>
    {% endif %}

    {% endblock %}

    {% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const formMw = document.getElementById('malware-form');
            const submitButtonMw = document.getElementById('submit-button-mw');
            const loadingIndicatorMw = document.getElementById('loading-indicator-mw');
            const fileInputMw = document.getElementById('file');

            if (formMw && submitButtonMw && loadingIndicatorMw && fileInputMw) {
                formMw.addEventListener('submit', function(event) {
                    if (fileInputMw.files.length === 0) {
                        console.log("Keine Datei f√ºr Malware-Upload ausgew√§hlt.");
                        return;
                    }
                    submitButtonMw.disabled = true;
                    loadingIndicatorMw.style.display = 'inline-flex';
                    submitButtonMw.style.display = 'none';
                });
            } else {
                console.error("Formular-Elemente f√ºr Malware-Ladeanzeige nicht gefunden!");
            }
        });
    </script>
    {% endblock %}